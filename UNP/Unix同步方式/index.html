<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="https://i.loli.net/2020/07/31/OZl2JxuSRrweIk5.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.loli.net/2020/07/31/OZl2JxuSRrweIk5.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.loli.net/2020/07/31/OZl2JxuSRrweIk5.jpg">
  <link rel="mask-icon" href="https://i.loli.net/2020/07/31/OZl2JxuSRrweIk5.jpg" color="#222">
  <meta name="google-site-verification" content="9bq58cqSUyZHa7gbv9RGCymVYlETH5LH8klswJlGmEY">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jakelin.cn","root":"/","images":"/images","scheme":"Gemini","version":"8.2.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="【重要的一句话】进程终止时系统不会自动释放所持有的锁，互斥锁、读写锁和Posix信号量。进程终止时内核总是自动清理的唯一同步锁类型是fcntl记录锁。">
<meta property="og:type" content="article">
<meta property="og:title" content="Unix同步方式">
<meta property="og:url" content="https://jakelin.cn/UNP/Unix%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F/index.html">
<meta property="og:site_name" content="JakeLin&#39;s Blog">
<meta property="og:description" content="【重要的一句话】进程终止时系统不会自动释放所持有的锁，互斥锁、读写锁和Posix信号量。进程终止时内核总是自动清理的唯一同步锁类型是fcntl记录锁。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/jakel-in/images/raw/master/2021-02/%E8%AE%B0%E5%BD%95%E9%94%81-%E5%BC%BA%E5%88%B6%E6%80%A7%E4%B8%8A%E9%94%81-%E9%94%99%E8%AF%AF.png">
<meta property="og:image" content="https://gitee.com/jakel-in/images/raw/master/2021-02/%E7%94%A8%E4%BA%8EPosix%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8.png">
<meta property="article:published_time" content="2021-02-01T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-04T07:16:38.981Z">
<meta property="article:author" content="jakelin">
<meta property="article:tag" content="unp">
<meta property="article:tag" content="IPC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/jakel-in/images/raw/master/2021-02/%E8%AE%B0%E5%BD%95%E9%94%81-%E5%BC%BA%E5%88%B6%E6%80%A7%E4%B8%8A%E9%94%81-%E9%94%99%E8%AF%AF.png">


<link rel="canonical" href="https://jakelin.cn/UNP/Unix%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>Unix同步方式 | JakeLin's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-174281095-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-174281095-1');
      }
    </script>

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9d00769a087a509cf354a71d17e57c14";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">JakeLin's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">世界上有10种人！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5"><span class="nav-number">1.</span> <span class="nav-text">同步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-number">2.</span> <span class="nav-text">互斥锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-number">2.1.</span> <span class="nav-text">初始化互斥锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%80%E6%AF%81%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-number">2.2.</span> <span class="nav-text">销毁互斥锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%94%81"><span class="nav-number">2.3.</span> <span class="nav-text">获取锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8A%E6%94%BE%E9%94%81"><span class="nav-number">2.4.</span> <span class="nav-text">释放锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%92%E6%96%A5%E9%94%81%E5%B1%9E%E6%80%A7"><span class="nav-number">2.5.</span> <span class="nav-text">互斥锁属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%92%E6%96%A5%E9%94%81%E4%B8%8E%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="nav-number">3.</span> <span class="nav-text">互斥锁与条件变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="nav-number">3.1.</span> <span class="nav-text">初始化条件变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%80%E6%AF%81%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="nav-number">3.2.</span> <span class="nav-text">销毁条件变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%89%E5%BE%85%E6%9D%A1%E4%BB%B6%E6%88%90%E7%AB%8B"><span class="nav-number">3.3.</span> <span class="nav-text">等待条件成立</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%8A%E7%9F%A5%E6%9D%A1%E4%BB%B6%E6%BB%A1%E8%B6%B3"><span class="nav-number">3.4.</span> <span class="nav-text">告知条件满足</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE"><span class="nav-number">3.5.</span> <span class="nav-text">条件变量属性设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E6%BB%A1%E8%B6%B3%E4%BF%A1%E5%8F%B7%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98"><span class="nav-number">3.6.</span> <span class="nav-text">条件满足信号丢失问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E9%94%81"><span class="nav-number">4.</span> <span class="nav-text">读写锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fcntl%E8%AE%B0%E5%BD%95%E4%B8%8A%E9%94%81"><span class="nav-number">5.</span> <span class="nav-text">fcntl记录上锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Posix-fcntl%E8%AE%B0%E5%BD%95%E4%B8%8A%E9%94%81"><span class="nav-number">5.1.</span> <span class="nav-text">Posix fcntl记录上锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E9%94%81%E5%87%A0%E4%B8%AA%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="nav-number">5.2.</span> <span class="nav-text">记录锁几个注意点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%9D%E5%91%8A%E6%80%A7%E4%B8%8A%E9%94%81"><span class="nav-number">5.3.</span> <span class="nav-text">劝告性上锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%BA%E5%88%B6%E6%80%A7%E4%B8%8A%E9%94%81"><span class="nav-number">5.4.</span> <span class="nav-text">强制性上锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Posix%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-number">6.</span> <span class="nav-text">Posix信号量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E4%BA%92%E6%96%A5%E9%94%81%E5%92%8C%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E9%97%B4%E7%9A%84%E5%B7%AE%E5%BC%82"><span class="nav-number">6.1.</span> <span class="nav-text">信号量、互斥锁和条件变量间的差异</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Posix%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="nav-number">6.2.</span> <span class="nav-text">Posix信号量函数调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sem-open%E3%80%81sem-close%E5%92%8Csem-unlink"><span class="nav-number">6.2.1.</span> <span class="nav-text">sem_open、sem_close和sem_unlink</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sem-wait%E5%92%8Csem-trywait"><span class="nav-number">6.2.2.</span> <span class="nav-text">sem_wait和sem_trywait</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sem-post%E5%92%8Csem-getvalue"><span class="nav-number">6.2.3.</span> <span class="nav-text">sem_post和sem_getvalue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sem-init%E5%92%8Csem-destroy"><span class="nav-number">6.2.4.</span> <span class="nav-text">sem_init和sem_destroy</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E9%99%90%E5%88%B6"><span class="nav-number">6.3.</span> <span class="nav-text">信号量限制</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="jakelin"
      src="https://i.loli.net/2020/07/31/OZl2JxuSRrweIk5.jpg">
  <p class="site-author-name" itemprop="name">jakelin</p>
  <div class="site-description" itemprop="description">一个记录、分享学习的地方</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/JakeLin0fly" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;JakeLin0fly" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jakelin0fly@gmail.com" title="E-Mail → mailto:jakelin0fly@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/JakeLin0fly" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jakelin.cn/UNP/Unix%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/31/OZl2JxuSRrweIk5.jpg">
      <meta itemprop="name" content="jakelin">
      <meta itemprop="description" content="一个记录、分享学习的地方">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JakeLin's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Unix同步方式
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-02 00:00:00" itemprop="dateCreated datePublished" datetime="2021-02-02T00:00:00+08:00">2021-02-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-04 15:16:38" itemprop="dateModified" datetime="2021-02-04T15:16:38+08:00">2021-02-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/unp/" itemprop="url" rel="index"><span itemprop="name">unp</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

            <div class="post-description">【重要的一句话】进程终止时系统不会自动释放所持有的锁，互斥锁、读写锁和Posix信号量。进程终止时内核总是自动清理的唯一同步锁类型是fcntl记录锁。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>【<strong>重要的一句话</strong>】<font color=red>进程终止时系统<strong>不会自动释放</strong>所持有的锁，<strong>互斥锁</strong>、<strong>读写锁</strong>和<strong>Posix信号量</strong>。进程终止时内核总是<strong>自动清理的唯一同步锁类型是fcntl记录锁</strong> </font>。进程终止时（无论自愿与否），内核会对其上仍然打开着的所有 <strong>有名信号量</strong> <strong>自动执行</strong> <code>sem_close</code> 信号量关闭操作（<strong>不是释放</strong>）。</p>
<p>System V信号量，应用程序可以选择进程终止时内核是否自动清理某个信号量。</p>
<h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><p><strong>同步</strong>（英语：synchronization），指在一个系统中所发生的事件（event）之间进行协调，在时间上出现一致性与统一化的现象。</p>
<p>为允许在线程或进程间共享数据，同步通常是必需的。本文涉及到的同步方式有：</p>
<ul>
<li>互斥锁</li>
<li>互斥锁与条件变量</li>
<li>读写锁</li>
<li>记录锁</li>
<li>Posix 信号量</li>
</ul>
<h2 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h2><p>互斥锁指代相互排斥，是最基本的同步形式。互斥锁用于保护 <em>临界区</em> ，以确保任何时刻只有一个线程（或进程）在执行其中的代码。伪代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lock_mutex(mutex);        <span class="comment">// 1.获取互斥锁</span></span><br><span class="line">do_something();            <span class="comment">// 2.访问临界区</span></span><br><span class="line">unlock_mutex(mutex);    <span class="comment">// 3.释放互斥锁</span></span><br></pre></td></tr></table></figure>

<p>尽管我们说互斥锁保护的是临界区，实际上保护的是在临界区中的被操作的数据，也就是共享数据。</p>
<p>互斥锁是 <font color=red><strong>协作性锁</strong></font> 。也就是说操作流程应该是在实际操作前获取互斥锁，但是没有办法防止某个线程（或进程）不先获取该互斥锁就操作数据。</p>
<h3 id="初始化互斥锁"><a href="#初始化互斥锁" class="headerlink" title="初始化互斥锁"></a>初始化互斥锁</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_init</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex, <span class="keyword">const</span> <span class="keyword">pthread_mutexattr_t</span> *attr)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>动态分配的，或者分配在共享内存区中的互斥锁必须使用 pthread_mutex_init 初始化。静态分配的可以初始化为常量 <code>PTHREAD_MUTEX_INITIALIZER</code> 。</li>
<li><code>attr = NULL</code> ，则使用默认属性。</li>
</ul>
<h3 id="销毁互斥锁"><a href="#销毁互斥锁" class="headerlink" title="销毁互斥锁"></a>销毁互斥锁</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_destroy</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="获取锁"><a href="#获取锁" class="headerlink" title="获取锁"></a>获取锁</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 阻塞，直到互斥锁解锁</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"><span class="comment">// 非阻塞，立即返回</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_trylock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>阻塞方式，若已有另外进程对互斥锁上锁，将阻塞到该互斥锁解锁</li>
<li>非阻塞方式，立即返回，若已有另外进程对互斥锁上锁，返回 EBUSY 错误</li>
</ul>
<h3 id="释放锁"><a href="#释放锁" class="headerlink" title="释放锁"></a>释放锁</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="互斥锁属性"><a href="#互斥锁属性" class="headerlink" title="互斥锁属性"></a>互斥锁属性</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutexattr_init</span><span class="params">(<span class="keyword">pthread_mutexattr_t</span> *attr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutexattr_destroy</span><span class="params">(<span class="keyword">pthread_mutexattr_t</span> *attr)</span></span>;</span><br><span class="line"><span class="comment">// 获取共享属性</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutexattr_getpshared</span><span class="params">(<span class="keyword">const</span> <span class="keyword">pthread_mutexattr_t</span> *<span class="keyword">restrict</span> attr, <span class="keyword">int</span> *<span class="keyword">restrict</span> pshared)</span></span>;</span><br><span class="line"><span class="comment">// 设置共享属性</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutexattr_setpshared</span><span class="params">(<span class="keyword">pthread_mutexattr_t</span> *attr, <span class="keyword">int</span> pshared)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>PTHREAD_PROCESS_SHARED</code> ，指定互斥锁在不同进程间共享</li>
<li><code>PTHREAD_PROCESS_PRIVATE</code>，指定互斥锁只能在单个进程内不同线程间共享（默认）</li>
</ul>
<h2 id="互斥锁与条件变量"><a href="#互斥锁与条件变量" class="headerlink" title="互斥锁与条件变量"></a>互斥锁与条件变量</h2><p>当期待的条目未准备好时，消某线程持有锁阻塞等待，锁住整个临界区。这样的情况还可能造成死锁，这不是我们想要的。我们的期望是在线程等待其他条件的时候，释放已获得的互斥锁。这时条件变量就完美符合我们的要求。</p>
<p><strong>互斥锁用于上锁，条件变量则用户等待</strong>。伪代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lock_mutex(mutex);        <span class="comment">// 1.获取互斥锁</span></span><br><span class="line">wait(cond, mutex);        <span class="comment">// 2.等待条件</span></span><br><span class="line">do_something();            <span class="comment">// 3.访问临界区</span></span><br><span class="line">unlock_mutex(mutex);    <span class="comment">// 4.释放互斥锁</span></span><br></pre></td></tr></table></figure>

<h3 id="初始化条件变量"><a href="#初始化条件变量" class="headerlink" title="初始化条件变量"></a>初始化条件变量</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_init</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond, <span class="keyword">const</span> <span class="keyword">pthread_condattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>动态分配的，或者分配在共享内存区中的互斥锁必须使用 pthread_cond_init 初始化。静态分配的可以初始化为常量 <code>PTHREAD_COND_INITIALIZER</code> </li>
</ul>
<h3 id="销毁条件变量"><a href="#销毁条件变量" class="headerlink" title="销毁条件变量"></a>销毁条件变量</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_destroy</span><span class="params">(<span class="keyword">pthread_cond_t</span> *cond)</span></span>;</span><br></pre></td></tr></table></figure>

<p>若有线程等待，则返回 EBUSY 错误。</p>
<h3 id="等待条件成立"><a href="#等待条件成立" class="headerlink" title="等待条件成立"></a>等待条件成立</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 阻塞等待</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_wait</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond, <span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex)</span></span>;</span><br><span class="line"><span class="comment">// 定时等待 允许设置阻塞时间限制</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_timedwait</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond, <span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex, <span class="keyword">const</span> struct timespec *<span class="keyword">restrict</span> abstime)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> &#123;</span></span><br><span class="line">    <span class="keyword">time_t</span>    tv_sec;     <span class="comment">// 秒</span></span><br><span class="line">    <span class="keyword">long</span>    tv_nsec;    <span class="comment">// 纳秒</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>每个条件变量总是与一个互斥锁关联，当条件不满足时，阻塞等待条件变量满足，并释放已获得的该互斥锁（原子操作）</li>
<li>当被唤醒，函数返回时，解除阻塞并重新申请获取互斥锁</li>
<li><code>pthread_cond_timedwait</code> ，允许线程就阻塞设置一个时间限制，该限制为 <strong>绝对时间</strong> ，超时返回 ETIMEDOUT 错误</li>
<li>使用绝对时间的好处：如果函数过早返回，那么同一函数无须改变其时间参数的内容就能再次被调用。</li>
</ul>
<h3 id="告知条件满足"><a href="#告知条件满足" class="headerlink" title="告知条件满足"></a>告知条件满足</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 至少唤醒一个等待该条件的线程</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_signal</span><span class="params">(<span class="keyword">pthread_cond_t</span> *cond)</span></span>;</span><br><span class="line"><span class="comment">// 唤醒等待该条件的所有线程</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_broadcast</span><span class="params">(<span class="keyword">pthread_cond_t</span> *cond)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>pthread_cond_signal</code> 至少唤醒一个等待该条件的线程</li>
<li><code>pthread_cond_broadcast</code> 唤醒等待该条件的所有线程，会造成 ”<strong>惊群</strong>“。</li>
</ul>
<h3 id="条件变量属性设置"><a href="#条件变量属性设置" class="headerlink" title="条件变量属性设置"></a>条件变量属性设置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_condattr_init</span><span class="params">(<span class="keyword">pthread_condattr_t</span> *attr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_condattr_destroy</span><span class="params">(<span class="keyword">pthread_condattr_t</span> *attr)</span></span>;</span><br><span class="line"><span class="comment">// 获取共享属性</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_condattr_getpshared</span><span class="params">(<span class="keyword">const</span> <span class="keyword">pthread_condattr_t</span> *<span class="keyword">restrict</span> attr, <span class="keyword">int</span> *<span class="keyword">restrict</span> pshared)</span></span>;</span><br><span class="line"><span class="comment">// 设置共享属性</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_condattr_setpshared</span><span class="params">(<span class="keyword">pthread_condattr_t</span> *attr, <span class="keyword">int</span> pshared)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>PTHREAD_PROCESS_SHARED</code> ，指定条件变量在不同进程间共享</li>
<li><code>PTHREAD_PROCESS_PRIVATE</code>，指定条件变量只能在单个进程内不同线程间共享（默认）</li>
</ul>
<h3 id="条件满足信号丢失问题"><a href="#条件满足信号丢失问题" class="headerlink" title="条件满足信号丢失问题"></a>条件满足信号丢失问题</h3><p>当条件满足，向一个条件变量发送信号时，若没有线程（或进程）等待该条件，则<strong>信号将会丢失</strong>。丢失和不再告知条件满足。</p>
<p>测试代码：<a target="_blank" rel="noopener" href="https://github.com/JakeLin0fly/unp-code/blob/master/sync/cond_signal_ignore.cpp">cond_signal_ignore.cpp</a> </p>
<p>测试结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sync]# ./signal_ignore </span><br><span class="line">主线程：子线程创建完毕</span><br><span class="line">主线程：获取到互斥锁</span><br><span class="line">主线程：发出 signal... </span><br><span class="line">主线程：释放掉互斥锁</span><br><span class="line">子线程：获取到互斥锁</span><br><span class="line">子线程：尝试获取条件变量...</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>

<h2 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h2><p>与互斥量类似，但读写锁允许更高的并行性。其特性为：<strong>读时共享，写时独占</strong>（写优先级高）</p>
<p>【读写锁】分配规则：<strong>共享-独占</strong> 上锁（读锁–共享锁，写锁–独占锁）</p>
<ol>
<li>若无线程持有给定的读写锁 <strong>写</strong> ，那么任意数目的线程可持有该读写锁 <strong>读</strong> ；</li>
<li>当且仅当无线程持有读写锁 <strong>读写</strong> 时，才分配读写锁用于 <strong>写</strong> 。</li>
</ol>
<p>基本操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态分配赋值常量 PTHREAD_RWLOCK_INITIALIZER</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_init</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *<span class="keyword">restrict</span> rwlock, <span class="keyword">const</span> <span class="keyword">pthread_rwlockattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读锁</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_rdlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_tryrdlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_timedrdlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *<span class="keyword">restrict</span> rwlock, <span class="keyword">const</span> struct timespec *<span class="keyword">restrict</span> abs_timeout)</span></span>;</span><br><span class="line"><span class="comment">// 写锁</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_wrlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_trywrlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_timedwrlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *<span class="keyword">restrict</span> rwlock, <span class="keyword">const</span> struct timespec *<span class="keyword">restrict</span> abs_timeout)</span></span>;</span><br><span class="line"><span class="comment">// 解锁</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_unlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br></pre></td></tr></table></figure>

<p>属性操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlockattr_getpshared</span><span class="params">(<span class="keyword">const</span> <span class="keyword">pthread_rwlockattr_t</span> *<span class="keyword">restrict</span> attr, <span class="keyword">int</span> *<span class="keyword">restrict</span> pshared)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlockattr_setpshared</span><span class="params">(<span class="keyword">pthread_rwlockattr_t</span> *attr, <span class="keyword">int</span> pshared)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>PTHREAD_PROCESS_SHARED</code> ，在不同进程间共享</li>
<li><code>PTHREAD_PROCESS_PRIVATE</code>，只能在单个进程内不同线程间共享（默认）</li>
</ul>
<h2 id="fcntl记录上锁"><a href="#fcntl记录上锁" class="headerlink" title="fcntl记录上锁"></a>fcntl记录上锁</h2><p>假设我们现在要设置某个锁，以实现对文件访问的同步。上面谈到的锁作用于整个文件，粒度较大，我们期望这个锁只作用与文件的 <em>记录（即字节范围）</em> 上。</p>
<blockquote>
<p>Unix内核没有文件内的记录这一概念，但内核提供的上锁特性却用 记录上锁（record locking）这一术语来描述。</p>
<p>粒度：用于标记能够锁住的对象的大小。通常情况下粒度越小，允许同时使用的用户数就越多。Posix 记录上锁的粒度为单字节。</p>
</blockquote>
<h3 id="Posix-fcntl记录上锁"><a href="#Posix-fcntl记录上锁" class="headerlink" title="Posix fcntl记录上锁"></a>Posix fcntl记录上锁</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fcntl</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> cmd, ... <span class="comment">/* struct flock *arg */</span> )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flock</span> &#123;</span></span><br><span class="line">    <span class="keyword">short</span> l_type;    <span class="comment">/* 锁类型: F_RDLCK, F_WRLCK, F_UNLCK */</span></span><br><span class="line">    <span class="keyword">short</span> l_whence;  <span class="comment">/* 偏移基准: SEEK_SET, SEEK_CUR, SEEK_END */</span></span><br><span class="line">    <span class="keyword">off_t</span> l_start;   <span class="comment">/* 相对偏移起始位置 */</span></span><br><span class="line">    <span class="keyword">off_t</span> l_len;     <span class="comment">/* 字节数  0--表示直到文件末尾*/</span></span><br><span class="line">    <span class="keyword">pid_t</span> l_pid;     <span class="comment">/* 进程ID（仅 F_GETLK） */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>cmd 参数</strong>:</p>
<ul>
<li><p><code>F_SETLK</code> ：</p>
<ul>
<li><strong>获取</strong>（ <code>l_type = F_RDLCK</code> 或 <code>l_type = F_WRLCK</code> ）或<strong>释放</strong>（<code>l_type = F_UNLCK</code>）由 arg 指向的 flock 结构所描述的锁。</li>
<li><strong>不阻塞</strong>，若无法将该锁授予调用进程，则立即返回 EACCESS 或 EAGAIN 错误。</li>
</ul>
</li>
<li><p><code>F_SETLKW</code> ：<strong>阻塞</strong>，作用同 F_SETLK</p>
</li>
<li><p><code>F_GETLK</code> ：</p>
<ul>
<li>检查有 arg 指向的锁以确定是否有某个已存在的锁会妨碍将新锁授予调用进程<ul>
<li>当前没有锁，返回 l_type = F_UNLCK</li>
<li>已存在锁，返回锁信息，包括持有该锁的进程ID</li>
</ul>
</li>
<li>提供该命令的原因：当指向 F_SETLK 命令返回错误时，获取导致错误文档某个锁信息（当然，连续使用两个命令不是原子操作，两个命令之间可能被解锁）</li>
</ul>
</li>
</ul>
<h3 id="记录锁几个注意点"><a href="#记录锁几个注意点" class="headerlink" title="记录锁几个注意点"></a>记录锁几个注意点</h3><ol>
<li>进程对文件上锁的类型受文件打开方式影响。</li>
<li>一个进程可以对某个文件的特定字节范围<strong>多次</strong>发出 F_SETLK 或 F_SETLKW 命令。每次成功与否取决于 <strong>其他进程</strong> 当时是否锁住该字节范围以及锁的类型，与本进程先前是否锁住该字节范围无关。</li>
<li>对于一个文件的任意字节，<strong>最多只能存在一种类型的记录锁</strong>（读锁或写锁）。一个给定字节可以有多个读锁，但只能有一个写锁。</li>
<li><strong>进程终止内核自动清理 fcntl 记录锁</strong>，对于一个打开着某个文件的进程来说，当关闭文件的所有描述符或进程本身终止时，与该文件关联的所有记录锁都被删除。</li>
<li><strong>不能继承</strong>，记录锁不能通过 fork 由子进程继承，记录锁跟进程ID紧密关联。</li>
<li>记录上锁<strong>不应该同标准I/O一块使用</strong>，因为标准I/O函数库会执行<strong>内部缓冲</strong>。应使用 read 和 write 系统调用。</li>
</ol>
<h3 id="劝告性上锁"><a href="#劝告性上锁" class="headerlink" title="劝告性上锁"></a>劝告性上锁</h3><p>Posix 记录上锁称为 <strong>劝告性上锁</strong> （advisory locking）。其含义是内核维护着由各个进程上锁的所有文件的正确信息，但是它不能防止一个进程写一个读锁定文件，或者读一个写锁定文件。（类似互斥锁的协作性）</p>
<h3 id="强制性上锁"><a href="#强制性上锁" class="headerlink" title="强制性上锁"></a>强制性上锁</h3><p>有些系统提供另一种类型文档记录上锁，称为 <strong>强制性上锁</strong> （mandatory locking）。使用强制性锁后，内核检查每个 read 和 write 请求，已验证起草组不会干扰由某个进程持有的某个锁。</p>
<p>若有干扰，对于阻塞式，冲突的 read 或 write 将把进程投入睡眠，直到锁释放。对于非阻塞式，返回 EAGAIN 错误。</p>
<p><strong>强制性上锁也会导致不一致的数据</strong>，若下图：</p>
<p><img src="https://gitee.com/jakel-in/images/raw/master/2021-02/%E8%AE%B0%E5%BD%95%E9%94%81-%E5%BC%BA%E5%88%B6%E6%80%A7%E4%B8%8A%E9%94%81-%E9%94%99%E8%AF%AF.png"></p>
<h2 id="Posix信号量"><a href="#Posix信号量" class="headerlink" title="Posix信号量"></a>Posix信号量</h2><p>信号量是一种用于提供进程（或线程）间同步手段的原语。</p>
<ul>
<li><strong>Posix有名信号量</strong>：由与文件系统中的路径名对应的名字来标识（并不要求它们真正的存放在文件系统内的某个文件）。</li>
<li><strong>Posix基于内存的信号量</strong>：即无名信号量，</li>
</ul>
<h3 id="信号量、互斥锁和条件变量间的差异"><a href="#信号量、互斥锁和条件变量间的差异" class="headerlink" title="信号量、互斥锁和条件变量间的差异"></a>信号量、互斥锁和条件变量间的差异</h3><ol>
<li>互斥锁总是由给它上锁的线程（或进程）解锁，信号量的挂出却不必由执行过它的等待操作的同一线程（或进程）执行。</li>
<li>互斥锁要么被锁在，要么被解开（二值状态，类似于 <strong>二值信号量</strong> ，其值或为0或为1）。</li>
<li>信号量有一个与之关联的状态（计数值），信号量的挂出操作总是被记住。当条件满足，向一个条件变量发送信号时，若没有线程（或进程）等待该条件，则<strong>信号将会丢失</strong>。</li>
<li>在同步技巧（互斥锁、条件变量、读写锁、信号量）中，能够从信号处理程序中安全调用的唯一函数是 <code>sem_post</code> 。</li>
</ol>
<h3 id="Posix信号量函数调用"><a href="#Posix信号量函数调用" class="headerlink" title="Posix信号量函数调用"></a>Posix信号量函数调用</h3><p><img src="https://gitee.com/jakel-in/images/raw/master/2021-02/%E7%94%A8%E4%BA%8EPosix%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8.png"></p>
<h4 id="sem-open、sem-close和sem-unlink"><a href="#sem-open、sem-close和sem-unlink" class="headerlink" title="sem_open、sem_close和sem_unlink"></a>sem_open、sem_close和sem_unlink</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个新的有名信号量，或打开一个已存在的有名信号量</span></span><br><span class="line"><span class="function"><span class="keyword">sem_t</span> *<span class="title">sem_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> oflag <span class="comment">/* , mode_t mode, unsigned int value */</span>)</span></span>;</span><br><span class="line"><span class="comment">// 关闭 sem_open 打开的有名信号量</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_close</span><span class="params">(<span class="keyword">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="comment">// 从系统中删除指定的有名信号量</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_unlink</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>进程终止</strong>时（无论自愿与否），内核会对其上仍然打开着的所有 <strong>有名信号量</strong> <strong>自动执行</strong> <code>sem_close</code> 信号量关闭操作（<strong>不是释放</strong>）。</li>
<li>关闭一个信号量斌没有将它从系统中删除，即，<strong>Posix有名信号量</strong> 至少是 <strong>随内核持续</strong> 的：即使当前没有进程打开着某个信号量，它的值仍然保持。</li>
<li><code>sem_unlink</code> 类似于文件I/O的 unlink 函数，当引用计数还大于0时， <code>name</code> 就能从文件系统中删除，但是<strong>信号量的析构</strong>（不同于将它名字从文件系统中删除）要等到最后一个 <code>sem_close</code> 发生时为止。</li>
</ul>
<h4 id="sem-wait和sem-trywait"><a href="#sem-wait和sem-trywait" class="headerlink" title="sem_wait和sem_trywait"></a>sem_wait和sem_trywait</h4><p>若信号量值大于0，将它减1。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_wait</span><span class="params">(<span class="keyword">sem_t</span> *sem)</span></span>;    <span class="comment">// 睡眠等待</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_trywait</span><span class="params">(<span class="keyword">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_timedwait</span><span class="params">(<span class="keyword">sem_t</span> *sem, <span class="keyword">const</span> struct timespec *abs_timeout)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="sem-post和sem-getvalue"><a href="#sem-post和sem-getvalue" class="headerlink" title="sem_post和sem_getvalue"></a>sem_post和sem_getvalue</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_post</span><span class="params">(<span class="keyword">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_getvalue</span><span class="params">(<span class="keyword">sem_t</span> *sem, <span class="keyword">int</span> *sval)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>sem_post</code>：信号量值加1，若信号量值因此大于0，唤醒一个等待的进程（或线程）</p>
<blockquote>
<p>If the semaphore’s value consequently becomes greater than  zero,  then  another  process  or  thread  blocked  in  a sem_wait(3) call will be woken up and proceed to lock the semaphore.</p>
</blockquote>
</li>
<li><p><code>sem_getvalue</code>：获取指定信号量的当前值。</p>
<p>若有不少于一个进程（或线程）等待，返回 valp 值：</p>
<ul>
<li>= 0；</li>
<li>&lt; 0，绝对值为等待的进程（或线程）数量。</li>
</ul>
</li>
</ul>
<h4 id="sem-init和sem-destroy"><a href="#sem-init和sem-destroy" class="headerlink" title="sem_init和sem_destroy"></a>sem_init和sem_destroy</h4><p><strong>Posix基于内存的信号量</strong> 操作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化一个基于内存的信号量</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_init</span><span class="params">(<span class="keyword">sem_t</span> *sem, <span class="keyword">int</span> pshared, <span class="keyword">unsigned</span> <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_destroy</span><span class="params">(<span class="keyword">sem_t</span> *sem)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>shared = 0</code> ：进程内各线程共享。</li>
<li><code>shared != 0</code> ：进程间共享。此时该信号量必须存放在某种类型的 <strong>共享内存区中</strong> ，使用它的进程都要能访问该共享内存区。</li>
<li>对于一个已初始化的信号量调用 <code>sem_init</code> ，其结果时未定义的。</li>
<li><strong>基于内存的信号量</strong> 具有 <strong>随进程</strong> 的持续性，其真正的持续性<strong>取决于存放信号量的内存区的类型</strong>。<ul>
<li>单个进程内线程共享，持续性随进程；</li>
<li>进程间共享，只要该共享内存区仍然存在，该信号量就继续存在。</li>
</ul>
</li>
</ul>
<h3 id="信号量限制"><a href="#信号量限制" class="headerlink" title="信号量限制"></a>信号量限制</h3><p>Posix定义了两个信号量限制：</p>
<ul>
<li><code>SEM_NSEMS_MAX</code>：一个进程可同时打开着的最大信号量数；</li>
<li><code>SEM_VALUE_MAX</code>：一个信号量的最大值。</li>
</ul>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\UNP\进程间通信方式(一)管道\" rel="bookmark">进程间通信方式(一)管道</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\UNP\Posix消息队列\" rel="bookmark">Posix消息队列</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\UNP\共享内存区\" rel="bookmark">共享内存区</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\UNP\IO模型中的同步&异步-阻塞&非阻塞\" rel="bookmark">I/O模型中的同步&异步-阻塞&非阻塞</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\UNP\基本TCP套接字\" rel="bookmark">基本TCP套接字</a></div>
    </li>
  </ul>


    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>jakelin
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://jakelin.cn/UNP/Unix%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F/" title="Unix同步方式">https://jakelin.cn/UNP/Unix同步方式/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/unp/" rel="tag"><i class="fa fa-tag"></i> unp</a>
              <a href="/tags/IPC/" rel="tag"><i class="fa fa-tag"></i> IPC</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/UNP/Posix%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="prev" title="Posix消息队列">
                  <i class="fa fa-chevron-left"></i> Posix消息队列
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/UNP/%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%8C%BA/" rel="next" title="共享内存区">
                  共享内存区 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">蜀ICP备20024949号-1 </a>
      <img src="https://i.loli.net/2020/07/31/b1SpDXthuFYemHN.png" style="display: inline-block;">
  </div>

<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jakelin</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">156k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">2:21</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<script type="text/javascript" src="/js/fold_action.js"></script>

<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class='fas fa-chevron-down'></i>    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class='fas fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
